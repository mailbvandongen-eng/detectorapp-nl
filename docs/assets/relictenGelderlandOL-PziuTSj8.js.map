{"version":3,"file":"relictenGelderlandOL-PziuTSj8.js","sources":["../../src/layers/relictenGelderlandOL.ts"],"sourcesContent":["import { Vector as VectorLayer } from 'ol/layer'\r\nimport { Vector as VectorSource } from 'ol/source'\r\nimport { Feature } from 'ol'\r\nimport { Point } from 'ol/geom'\r\nimport proj4 from 'proj4'\r\nimport { register } from 'ol/proj/proj4'\r\nimport { Style, Icon } from 'ol/style'\r\n\r\n// Ensure EPSG:28992 is registered\r\nproj4.defs('EPSG:28992', '+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +towgs84=565.417,50.3319,465.552,-0.398957,0.343988,-1.8774,4.0725 +units=m +no_defs')\r\nregister(proj4)\r\n\r\n// Cache for localStorage\r\nconst CACHE_KEY = 'relicten_gelderland_cache_v2'\r\nconst CACHE_DURATION = 14 * 24 * 60 * 60 * 1000 // 14 days (data doesn't change often)\r\n\r\ninterface RelictFeature {\r\n  coords: [number, number] // lon, lat (WGS84)\r\n  type: string\r\n  klasse: number\r\n}\r\n\r\ninterface RelictCache {\r\n  timestamp: number\r\n  data: RelictFeature[]\r\n}\r\n\r\n// Type code to icon mapping\r\n// Type codes are like \"KV14\", \"K21\", \"B35\" - we extract the letter prefix\r\nconst TYPE_ICONS: Record<string, { icon: string; color: string; name: string }> = {\r\n  'KV': { icon: 'castle', color: '#7c3aed', name: 'Kasteel/Vesting' },\r\n  'K': { icon: 'church', color: '#9333ea', name: 'Kapel' },\r\n  'M': { icon: 'windmill', color: '#b45309', name: 'Molen' },\r\n  'EK': { icon: 'duck', color: '#0891b2', name: 'Eendenkooi' },\r\n  'H': { icon: 'estate', color: '#4f46e5', name: 'Havezate' },\r\n  'B': { icon: 'farm', color: '#65a30d', name: 'Boerderij' },\r\n  'OB': { icon: 'ruins', color: '#6b7280', name: 'Oude Bebouwing' },\r\n  'WM': { icon: 'watermill', color: '#0284c7', name: 'Watermolen' },\r\n  'BR': { icon: 'bridge', color: '#64748b', name: 'Brug' },\r\n  'S': { icon: 'landmark', color: '#0f766e', name: 'Spoor/Relict' },\r\n  'G': { icon: 'tumulus', color: '#854d0e', name: 'Graf/Heuvel' },\r\n  'T': { icon: 'terp', color: '#0d9488', name: 'Terp' },\r\n  'P': { icon: 'well', color: '#0d9488', name: 'Put/Bron' },\r\n  'V': { icon: 'bunker', color: '#57534e', name: 'Verdediging' }\r\n}\r\n\r\n// Default style for unknown types\r\nconst DEFAULT_ICON = { icon: 'mapPin', color: '#dc2626', name: 'Onbekend' }\r\n\r\n// Lucide icon SVG paths\r\nconst LUCIDE_ICONS: Record<string, string> = {\r\n  castle: 'M22 20v-9H2v9M2 14h20M12 11V2M10 2h4M6 11V5M4 5h4M18 11V5M16 5h4M7 14v6M12 14v6M17 14v6',\r\n  church: 'M12 2v4M10 4h4M4 22V12l8-6 8 6v10M4 22h16M9 22v-6h6v6',\r\n  windmill: 'M12 2v20M12 12l8-4M12 12l-8-4M12 12l4 8M12 12l-4 8',\r\n  duck: 'M4 16c0-4 4-8 8-8s8 4 8 8H4zM12 8V4M10 4h4M8 12h8',\r\n  estate: 'M3 21h18M6 21V12l6-5 6 5v9M10 21v-4h4v4M6 12V9M18 12V9M4 9l8-6 8 6',\r\n  watermill: 'M2 16h20M6 16v5M18 16v5M12 2v6M12 8a6 6 0 1 0 0 12M8 14h8',\r\n  well: 'M8 21v-6M16 21v-6M6 15h12M9 15V9a3 3 0 0 1 6 0v6M12 3v2',\r\n  farm: 'M3 21h18M5 21V10l7-7 7 7v11M10 21v-4h4v4',\r\n  bridge: 'M2 18h20M4 18v-4c0-2 3.5-4 8-4s8 2 8 4v4M8 10v8M16 10v8',\r\n  ruins: 'M3 22h4V14h2v8h6v-8h2v8h4M5 14l7-10l7 10M9 10h6',\r\n  landmark: 'M3 22h18M6 18v4M10 18v4M14 18v4M18 18v4M12 2l10 8H2l10-8z',\r\n  tumulus: 'M2 20h20M4 20c0-6 3.5-12 8-12s8 6 8 12',\r\n  terp: 'M2 20h20M4 20c0-5 3-10 8-10s8 5 8 10M10 10v-3h4v3',\r\n  bunker: 'M3 21h18M5 21V7l7-4 7 4v14M9 21V11h6v10M9 11h6M5 7h14',\r\n  mapPin: 'M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0ZM12 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4z'\r\n}\r\n\r\n// Create SVG icon with filled circle background\r\nfunction createFilledIconSvg(iconPath: string, bgColor: string, size: number = 28): string {\r\n  const svg = `<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"${size}\" height=\"${size}\" viewBox=\"0 0 32 32\">\r\n    <circle cx=\"16\" cy=\"16\" r=\"14\" fill=\"${bgColor}\" stroke=\"white\" stroke-width=\"2\"/>\r\n    <g transform=\"translate(4, 4) scale(1)\">\r\n      <path d=\"${iconPath}\" fill=\"none\" stroke=\"white\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\r\n    </g>\r\n  </svg>`\r\n  return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg)\r\n}\r\n\r\n// Extract type prefix from full type code (e.g., \"KV14\" -> \"KV\", \"K21\" -> \"K\")\r\nfunction extractTypePrefix(typeCode: string): string {\r\n  if (!typeCode) return ''\r\n  // Match letters at start, up to 2 characters\r\n  const match = typeCode.match(/^([A-Z]{1,2})/)\r\n  return match ? match[1] : ''\r\n}\r\n\r\n// Get style for a feature based on its type\r\nfunction getRelictStyle(typeCode: string, resolution: number): Style {\r\n  const prefix = extractTypePrefix(typeCode)\r\n  const iconInfo = TYPE_ICONS[prefix] || DEFAULT_ICON\r\n  const iconPath = LUCIDE_ICONS[iconInfo.icon] || LUCIDE_ICONS.mapPin\r\n\r\n  // Scale based on zoom\r\n  let scale = 1.0\r\n  if (resolution > 100) scale = 0.5\r\n  else if (resolution > 50) scale = 0.6\r\n  else if (resolution > 20) scale = 0.8\r\n  else if (resolution > 10) scale = 0.9\r\n\r\n  const svgSrc = createFilledIconSvg(iconPath, iconInfo.color)\r\n\r\n  return new Style({\r\n    image: new Icon({\r\n      src: svgSrc,\r\n      scale: scale,\r\n      anchor: [0.5, 0.5]\r\n    })\r\n  })\r\n}\r\n\r\n// Style cache to avoid recreating styles\r\nconst styleCache = new Map<string, Style>()\r\n\r\nfunction getCachedStyle(typeCode: string, resolution: number): Style {\r\n  // Round resolution to nearest 10 for caching\r\n  const roundedRes = Math.round(resolution / 10) * 10\r\n  const cacheKey = `${extractTypePrefix(typeCode)}-${roundedRes}`\r\n\r\n  let style = styleCache.get(cacheKey)\r\n  if (!style) {\r\n    style = getRelictStyle(typeCode, resolution)\r\n    styleCache.set(cacheKey, style)\r\n  }\r\n  return style\r\n}\r\n\r\n/**\r\n * Fetch Relicten data from Gelderland WFS service\r\n */\r\nasync function fetchRelicten(): Promise<RelictFeature[]> {\r\n  // Check cache first\r\n  try {\r\n    const cached = localStorage.getItem(CACHE_KEY)\r\n    if (cached) {\r\n      const { timestamp, data } = JSON.parse(cached) as RelictCache\r\n      if (Date.now() - timestamp < CACHE_DURATION) {\r\n        console.log(`âœ“ Relicten Gelderland loaded from cache (${data.length} features)`)\r\n        return data\r\n      }\r\n    }\r\n  } catch {\r\n    // Cache read failed\r\n  }\r\n\r\n  // Fetch from WFS\r\n  const wfsUrl = 'https://geoserver.gelderland.nl/geoserver/ngr_a/wfs?' +\r\n    'service=WFS&version=2.0.0&request=GetFeature' +\r\n    '&typeName=ChAr_Relictenkaart_p' +\r\n    '&outputFormat=application/json'\r\n\r\n  try {\r\n    console.log('ðŸ”„ Relicten Gelderland: laden van WFS...')\r\n    const response = await fetch(wfsUrl)\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`WFS error: ${response.status}`)\r\n    }\r\n\r\n    const data = await response.json()\r\n\r\n    const features: RelictFeature[] = data.features\r\n      .filter((f: any) => f.geometry && f.geometry.coordinates)\r\n      .map((f: any) => {\r\n        // Convert RD (EPSG:28992) to WGS84 (EPSG:4326)\r\n        const rdCoords = f.geometry.coordinates\r\n        const wgs84 = proj4('EPSG:28992', 'EPSG:4326', rdCoords)\r\n\r\n        return {\r\n          coords: wgs84 as [number, number],\r\n          type: f.properties.type || '',\r\n          klasse: f.properties.klasse || 0\r\n        }\r\n      })\r\n\r\n    // Cache the result\r\n    try {\r\n      const cache: RelictCache = { timestamp: Date.now(), data: features }\r\n      localStorage.setItem(CACHE_KEY, JSON.stringify(cache))\r\n      console.log(`âœ“ Relicten Gelderland cached (${features.length} features)`)\r\n    } catch {\r\n      console.warn('âš  Could not cache Relicten Gelderland (too large)')\r\n    }\r\n\r\n    console.log(`âœ“ Relicten Gelderland fetched from WFS (${features.length} features)`)\r\n    return features\r\n\r\n  } catch (error) {\r\n    console.warn('âš  Failed to fetch Relicten Gelderland:', error)\r\n\r\n    // Try stale cache\r\n    try {\r\n      const cached = localStorage.getItem(CACHE_KEY)\r\n      if (cached) {\r\n        const { data } = JSON.parse(cached) as RelictCache\r\n        console.log(`âœ“ Using stale cache (${data.length} features)`)\r\n        return data\r\n      }\r\n    } catch {\r\n      // No cache\r\n    }\r\n\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Relictenkaart Punten Gelderland - met eigen iconen\r\n * Havezaten, molens, eendenkooien, kastelen, kapellen, etc.\r\n * Bron: Provincie Gelderland via WFS\r\n * Uses lazy loading - data is only fetched when layer is first made visible\r\n */\r\nexport async function createRelictenPuntenLayerOL() {\r\n  // Start with empty source - data loaded lazily\r\n  const source = new VectorSource()\r\n  let dataLoaded = false\r\n  let isLoading = false\r\n\r\n  const layer = new VectorLayer({\r\n    source: source,\r\n    properties: { title: 'Relictenkaart Punten', type: 'overlay' },\r\n    visible: false,\r\n    style: (feature, resolution) => {\r\n      const typeCode = feature.get('type') || ''\r\n      return getCachedStyle(typeCode, resolution)\r\n    },\r\n    zIndex: 20,\r\n    maxResolution: 150 // Alleen tonen vanaf ~10km hoogte\r\n  })\r\n\r\n  // Lazy load data when layer becomes visible\r\n  layer.on('change:visible', async () => {\r\n    if (layer.getVisible() && !dataLoaded && !isLoading) {\r\n      isLoading = true\r\n\r\n      const relictData = await fetchRelicten()\r\n\r\n      const features = relictData.map(item => {\r\n        // Convert lon/lat to Web Mercator\r\n        const mercator = proj4('EPSG:4326', 'EPSG:3857', item.coords)\r\n        const feature = new Feature({\r\n          geometry: new Point(mercator),\r\n          type: item.type,\r\n          klasse: item.klasse\r\n        })\r\n        return feature\r\n      })\r\n\r\n      source.addFeatures(features)\r\n      dataLoaded = true\r\n      isLoading = false\r\n      console.log(`âœ“ Relictenkaart Punten geladen (${features.length} punten)`)\r\n    }\r\n  })\r\n\r\n  return layer\r\n}\r\n\r\n// Export type info for popup usage\r\nexport const RELICT_TYPE_INFO = TYPE_ICONS\r\n"],"names":["proj4","register","CACHE_KEY","CACHE_DURATION","TYPE_ICONS","DEFAULT_ICON","LUCIDE_ICONS","createFilledIconSvg","iconPath","bgColor","size","svg","extractTypePrefix","typeCode","match","getRelictStyle","resolution","prefix","iconInfo","scale","svgSrc","Style","Icon","styleCache","getCachedStyle","roundedRes","cacheKey","style","fetchRelicten","cached","timestamp","data","wfsUrl","response","features","f","rdCoords","cache","error","createRelictenPuntenLayerOL","source","VectorSource","dataLoaded","isLoading","layer","VectorLayer","feature","item","mercator","Feature","Point"],"mappings":"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"}