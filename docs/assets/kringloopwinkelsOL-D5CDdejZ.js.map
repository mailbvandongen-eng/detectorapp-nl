{"version":3,"file":"kringloopwinkelsOL-D5CDdejZ.js","sources":["../../src/layers/kringloopwinkelsOL.ts"],"sourcesContent":["import { Vector as VectorLayer } from 'ol/layer'\nimport { Vector as VectorSource } from 'ol/source'\nimport { Feature } from 'ol'\nimport { Point } from 'ol/geom'\nimport { fromLonLat } from 'ol/proj'\nimport { LAYER_STYLES } from './iconStyles'\n\n// Cache key for localStorage\nconst CACHE_KEY = 'kringloopwinkels_cache'\nconst CACHE_DURATION = 24 * 60 * 60 * 1000 // 24 hours in ms\n\ninterface KringloopCache {\n  timestamp: number\n  data: KringloopFeature[]\n}\n\ninterface KringloopFeature {\n  lon: number\n  lat: number\n  name?: string\n  website?: string\n  phone?: string\n  address?: string\n  opening_hours?: string\n}\n\n/**\n * Fetch kringloopwinkels from OpenStreetMap via Overpass API\n * Returns cached data if available and fresh\n */\nasync function fetchKringloopwinkels(): Promise<KringloopFeature[]> {\n  // Check cache first\n  try {\n    const cached = localStorage.getItem(CACHE_KEY)\n    if (cached) {\n      const { timestamp, data } = JSON.parse(cached) as KringloopCache\n      if (Date.now() - timestamp < CACHE_DURATION) {\n        console.log(`âœ“ Kringloopwinkels loaded from cache (${data.length} locations)`)\n        return data\n      }\n    }\n  } catch {\n    // Cache read failed, continue to fetch\n  }\n\n  // Fetch fresh data from Overpass API\n  const query = `\n    [out:json][timeout:30];\n    area[\"ISO3166-1\"=\"NL\"]->.nl;\n    (\n      nwr[\"shop\"=\"second_hand\"](area.nl);\n      nwr[\"shop\"=\"charity\"](area.nl);\n      nwr[\"second_hand\"=\"yes\"](area.nl);\n    );\n    out center;\n  `\n\n  try {\n    const response = await fetch('https://overpass-api.de/api/interpreter', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n      body: `data=${encodeURIComponent(query)}`\n    })\n\n    if (!response.ok) {\n      throw new Error(`Overpass API error: ${response.status}`)\n    }\n\n    const data = await response.json()\n\n    const features: KringloopFeature[] = data.elements\n      .filter((el: any) => {\n        // Get coordinates - either from node or from center of way/relation\n        const lon = el.lon ?? el.center?.lon\n        const lat = el.lat ?? el.center?.lat\n        return lon && lat\n      })\n      .map((el: any) => {\n        const tags = el.tags || {}\n        const lon = el.lon ?? el.center?.lon\n        const lat = el.lat ?? el.center?.lat\n\n        // Build address from components\n        const addressParts = [\n          tags['addr:street'],\n          tags['addr:housenumber'],\n          tags['addr:postcode'],\n          tags['addr:city']\n        ].filter(Boolean)\n\n        return {\n          lon,\n          lat,\n          name: tags.name || tags.operator || 'Kringloopwinkel',\n          website: tags.website || tags['contact:website'],\n          phone: tags.phone || tags['contact:phone'],\n          address: addressParts.length > 0 ? addressParts.join(' ') : undefined,\n          opening_hours: tags.opening_hours\n        }\n      })\n\n    // Cache the result\n    try {\n      const cache: KringloopCache = { timestamp: Date.now(), data: features }\n      localStorage.setItem(CACHE_KEY, JSON.stringify(cache))\n    } catch {\n      // Cache write failed (quota exceeded?), continue anyway\n    }\n\n    console.log(`âœ“ Kringloopwinkels fetched from OSM (${features.length} locations)`)\n    return features\n\n  } catch (error) {\n    console.warn('âš  Failed to fetch kringloopwinkels from Overpass:', error)\n\n    // Try to return stale cache if available\n    try {\n      const cached = localStorage.getItem(CACHE_KEY)\n      if (cached) {\n        const { data } = JSON.parse(cached) as KringloopCache\n        console.log(`âœ“ Using stale cache (${data.length} locations)`)\n        return data\n      }\n    } catch {\n      // No cache available\n    }\n\n    return []\n  }\n}\n\n/**\n * Kringloopwinkels (thrift stores) in Nederland\n * Bron: OpenStreetMap via Overpass API (live data)\n * ~840+ locaties\n * Uses lazy loading - data is only fetched when layer is first made visible\n */\nexport async function createKringloopwinkelsLayerOL() {\n  // Start with empty source - data loaded lazily\n  const source = new VectorSource()\n  let dataLoaded = false\n  let isLoading = false\n\n  const layer = new VectorLayer({\n    source: source,\n    properties: { title: 'Kringloopwinkels', type: 'overlay' },\n    visible: false,\n    style: LAYER_STYLES.recycle(),\n    zIndex: 27\n  })\n\n  // Lazy load data when layer becomes visible\n  layer.on('change:visible', async () => {\n    if (layer.getVisible() && !dataLoaded && !isLoading) {\n      isLoading = true\n      console.log('ðŸ”„ Kringloopwinkels: laden...')\n\n      const kringloopData = await fetchKringloopwinkels()\n\n      const features = kringloopData.map(item => {\n        const feature = new Feature({\n          geometry: new Point(fromLonLat([item.lon, item.lat])),\n          name: item.name,\n          website: item.website,\n          phone: item.phone,\n          address: item.address,\n          opening_hours: item.opening_hours\n        })\n        return feature\n      })\n\n      source.addFeatures(features)\n      dataLoaded = true\n      isLoading = false\n      console.log(`âœ“ Kringloopwinkels geladen (${features.length} winkels)`)\n    }\n  })\n\n  return layer\n}\n"],"names":["CACHE_KEY","CACHE_DURATION","fetchKringloopwinkels","cached","timestamp","data","query","response","features","el","lon","lat","tags","addressParts","cache","error","createKringloopwinkelsLayerOL","source","VectorSource","dataLoaded","isLoading","layer","VectorLayer","LAYER_STYLES","item","Feature","Point","fromLonLat"],"mappings":"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"}