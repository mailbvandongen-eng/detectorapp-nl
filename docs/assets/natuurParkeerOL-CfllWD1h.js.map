{"version":3,"file":"natuurParkeerOL-CfllWD1h.js","sources":["../../src/layers/natuurParkeerOL.ts"],"sourcesContent":["import { Vector as VectorLayer } from 'ol/layer'\r\nimport { Vector as VectorSource } from 'ol/source'\r\nimport { Feature } from 'ol'\r\nimport { Point } from 'ol/geom'\r\nimport { fromLonLat } from 'ol/proj'\r\nimport { Style, Icon } from 'ol/style'\r\n\r\n// Cache for localStorage\r\nconst CACHE_KEY = 'natuurparkeer_cache'\r\nconst CACHE_DURATION = 24 * 60 * 60 * 1000 // 24 hours\r\n\r\ninterface ParkeerCache {\r\n  timestamp: number\r\n  data: ParkeerFeature[]\r\n}\r\n\r\ninterface ParkeerFeature {\r\n  lon: number\r\n  lat: number\r\n  name?: string\r\n  fee?: string\r\n  capacity?: string\r\n  access?: string\r\n  surface?: string\r\n  operator?: string\r\n  opening_hours?: string\r\n  natuurgebied?: string\r\n}\r\n\r\n/**\r\n * Fetch parking areas near nature reserves from OpenStreetMap via Overpass API\r\n */\r\nasync function fetchNatuurParkeer(): Promise<ParkeerFeature[]> {\r\n  // Check cache first\r\n  try {\r\n    const cached = localStorage.getItem(CACHE_KEY)\r\n    if (cached) {\r\n      const { timestamp, data } = JSON.parse(cached) as ParkeerCache\r\n      if (Date.now() - timestamp < CACHE_DURATION) {\r\n        console.log(`âœ“ Natuurparkeerplaatsen loaded from cache (${data.length} locations)`)\r\n        return data\r\n      }\r\n    }\r\n  } catch {\r\n    // Cache read failed\r\n  }\r\n\r\n  // Fetch parking areas associated with nature reserves, forests, parks\r\n  // This query finds parking tagged as hiking/nature parking or near nature areas\r\n  const query = `\r\n    [out:json][timeout:60];\r\n    area[\"ISO3166-1\"=\"NL\"]->.nl;\r\n    (\r\n      // Parking explicitly tagged for hiking or nature\r\n      nwr[\"amenity\"=\"parking\"][\"hiking\"=\"yes\"](area.nl);\r\n      nwr[\"amenity\"=\"parking\"][\"leisure\"~\"nature_reserve|park\"](area.nl);\r\n      nwr[\"amenity\"=\"parking\"][\"tourism\"=\"trailhead\"](area.nl);\r\n      nwr[\"amenity\"=\"parking\"][\"access\"=\"customers\"][\"operator\"~\"Staatsbosbeheer|Natuurmonumenten|Landschap\"](area.nl);\r\n      // Parking with nature-related names\r\n      nwr[\"amenity\"=\"parking\"][\"name\"~\"bos|natuur|heide|duin|wandel|Staatsbosbeheer|Natuurmonumenten\",i](area.nl);\r\n    );\r\n    out center;\r\n  `\r\n\r\n  try {\r\n    const response = await fetch('https://overpass-api.de/api/interpreter', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n      body: `data=${encodeURIComponent(query)}`\r\n    })\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Overpass API error: ${response.status}`)\r\n    }\r\n\r\n    const data = await response.json()\r\n\r\n    const features: ParkeerFeature[] = data.elements\r\n      .filter((el: any) => {\r\n        const lon = el.lon ?? el.center?.lon\r\n        const lat = el.lat ?? el.center?.lat\r\n        return lon && lat\r\n      })\r\n      .map((el: any) => {\r\n        const tags = el.tags || {}\r\n        const lon = el.lon ?? el.center?.lon\r\n        const lat = el.lat ?? el.center?.lat\r\n\r\n        // Determine fee status text\r\n        let feeText = tags.fee\r\n        if (feeText === 'yes') feeText = 'Betaald'\r\n        else if (feeText === 'no') feeText = 'Gratis'\r\n\r\n        return {\r\n          lon,\r\n          lat,\r\n          name: tags.name || 'Parkeerplaats',\r\n          fee: feeText,\r\n          capacity: tags.capacity,\r\n          access: tags.access,\r\n          surface: tags.surface,\r\n          operator: tags.operator,\r\n          opening_hours: tags.opening_hours,\r\n          natuurgebied: tags['is_in'] || tags.description\r\n        }\r\n      })\r\n\r\n    // Cache the result\r\n    try {\r\n      const cache: ParkeerCache = { timestamp: Date.now(), data: features }\r\n      localStorage.setItem(CACHE_KEY, JSON.stringify(cache))\r\n    } catch {\r\n      // Cache write failed\r\n    }\r\n\r\n    console.log(`âœ“ Natuurparkeerplaatsen fetched from OSM (${features.length} locations)`)\r\n    return features\r\n\r\n  } catch (error) {\r\n    console.warn('âš  Failed to fetch natuurparkeer from Overpass:', error)\r\n\r\n    // Try stale cache\r\n    try {\r\n      const cached = localStorage.getItem(CACHE_KEY)\r\n      if (cached) {\r\n        const { data } = JSON.parse(cached) as ParkeerCache\r\n        console.log(`âœ“ Using stale cache (${data.length} locations)`)\r\n        return data\r\n      }\r\n    } catch {\r\n      // No cache\r\n    }\r\n\r\n    return []\r\n  }\r\n}\r\n\r\n// Create parking icon SVG - green/nature themed\r\nfunction createParkeerIcon(fee?: string): string {\r\n  // Green for free, orange for paid\r\n  const bgColor = fee === 'Betaald' ? '#f59e0b' : '#22c55e'\r\n\r\n  const svg = `<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"28\" height=\"28\" viewBox=\"0 0 32 32\">\r\n    <circle cx=\"16\" cy=\"16\" r=\"13\" fill=\"${bgColor}\" stroke=\"white\" stroke-width=\"2\"/>\r\n    <text x=\"16\" y=\"21\" font-family=\"Arial, sans-serif\" font-size=\"16\" font-weight=\"bold\" fill=\"white\" text-anchor=\"middle\">P</text>\r\n  </svg>`\r\n  return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg)\r\n}\r\n\r\n// Style cache\r\nconst styleCache = new Map<string, Style>()\r\n\r\n// Create style based on zoom and fee\r\nfunction getParkeerStyle(feature: any, resolution: number): Style {\r\n  const fee = feature.get('fee') || 'unknown'\r\n\r\n  let scale = 1.0\r\n  if (resolution > 150) scale = 0.5\r\n  else if (resolution > 75) scale = 0.6\r\n  else if (resolution > 40) scale = 0.7\r\n  else if (resolution > 20) scale = 0.85\r\n  else if (resolution > 10) scale = 1.0\r\n  else scale = 1.2\r\n\r\n  const cacheKey = `parkeer-${fee}-${scale.toFixed(2)}`\r\n  let style = styleCache.get(cacheKey)\r\n\r\n  if (!style) {\r\n    style = new Style({\r\n      image: new Icon({\r\n        src: createParkeerIcon(fee),\r\n        scale: scale,\r\n        anchor: [0.5, 0.5]\r\n      })\r\n    })\r\n    styleCache.set(cacheKey, style)\r\n  }\r\n\r\n  return style\r\n}\r\n\r\n/**\r\n * Parkeerplaatsen bij natuurgebieden in Nederland\r\n * Bron: OpenStreetMap via Overpass API\r\n * Groen = gratis, Oranje = betaald\r\n * Uses lazy loading - data is only fetched when layer is first made visible\r\n */\r\nexport async function createNatuurParkeerLayerOL() {\r\n  // Start with empty source - data loaded lazily\r\n  const source = new VectorSource()\r\n  let dataLoaded = false\r\n  let isLoading = false\r\n\r\n  const layer = new VectorLayer({\r\n    source: source,\r\n    properties: { title: 'Natuurparkeren', type: 'overlay' },\r\n    visible: false,\r\n    style: (feature, resolution) => getParkeerStyle(feature, resolution),\r\n    zIndex: 26\r\n  })\r\n\r\n  // Lazy load data when layer becomes visible\r\n  layer.on('change:visible', async () => {\r\n    if (layer.getVisible() && !dataLoaded && !isLoading) {\r\n      isLoading = true\r\n      console.log('ðŸ”„ Natuurparkeren: laden...')\r\n\r\n      const parkeerData = await fetchNatuurParkeer()\r\n\r\n      const features = parkeerData.map(item => {\r\n        const feature = new Feature({\r\n          geometry: new Point(fromLonLat([item.lon, item.lat])),\r\n          name: item.name,\r\n          fee: item.fee,\r\n          capacity: item.capacity,\r\n          access: item.access,\r\n          surface: item.surface,\r\n          operator: item.operator,\r\n          opening_hours: item.opening_hours,\r\n          natuurgebied: item.natuurgebied\r\n        })\r\n        return feature\r\n      })\r\n\r\n      source.addFeatures(features)\r\n      dataLoaded = true\r\n      isLoading = false\r\n      console.log(`âœ“ Natuurparkeren geladen (${features.length} locaties)`)\r\n    }\r\n  })\r\n\r\n  return layer\r\n}\r\n"],"names":["CACHE_KEY","CACHE_DURATION","fetchNatuurParkeer","cached","timestamp","data","query","response","features","el","lon","lat","tags","feeText","cache","error","createParkeerIcon","fee","styleCache","getParkeerStyle","feature","resolution","scale","cacheKey","style","Style","Icon","createNatuurParkeerLayerOL","source","VectorSource","dataLoaded","isLoading","layer","VectorLayer","item","Feature","Point","fromLonLat"],"mappings":"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"}